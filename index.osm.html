<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>–†—É—Å—Å–∫–∞—è –∫–∞—Ä—Ç–∞ –ë–ê ‚Äî OSM</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css">
<style>
  html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  .app{display:grid;grid-template-rows:auto 1fr;height:100%}
  header{padding:10px 12px;border-bottom:1px solid #222;background:#111;color:#eee;display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  header .btn{padding:6px 10px;background:#222;border:1px solid #333;border-radius:14px;color:#ddd;cursor:pointer}
  header .btn.active{background:#0b57d0;border-color:#0b57d0;color:#fff}
  #map{height:100%}

  /* –ü–ò–ù-–°–û–ë–´–¢–ò–Ø: –∏–∫–æ–Ω–∫–∞ + –ø–æ–¥–ø–∏—Å—å –≤ –æ–¥–Ω–æ–º –±–µ–π–¥–∂–µ */
  .pinwrap{
    display:flex;align-items:center;gap:6px;
    background:rgba(0,0,0,.85);color:#fff;border:1px solid rgba(255,255,255,.2);
    border-radius:14px;padding:4px 8px;font-size:13px;font-weight:600;white-space:nowrap;
    box-shadow:0 2px 6px rgba(0,0,0,.35);pointer-events:none;
  }
  .pin-emoji{font-size:16px;line-height:1}
  .pin-name{max-width:220px;overflow:hidden;text-overflow:ellipsis}
  @media (max-width:600px){ .pin-name{max-width:140px} }
</style>
</head>
<body>
<div class="app">
  <header>
    <div><strong>–†—É—Å—Å–∫–∞—è –∫–∞—Ä—Ç–∞ –ë–ê</strong></div>
    <button id="heat" class="btn">–ü–ª–æ—Ç–Ω–æ—Å—Ç—å —Ä—É—Å—Å–∫–∏—Ö</button>
    <button id="route" class="btn">–ú–∞—Ä—à—Ä—É—Ç –ø—è—Ç–Ω–∏—Ü—ã</button>
  </header>
  <div id="map"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>

<script src="./data/places.js"></script>
<script src="./data/routes.js"></script>
<script>
const map = L.map('map', {zoomControl:true}).setView([-34.6037,-58.3816], 12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'¬© OpenStreetMap'}).addTo(map);

const cluster = L.markerClusterGroup({ chunkedLoading:true });
const labelLayer = L.layerGroup().addTo(map);

// —ç–º–æ–¥–∑–∏ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
const CAT_EMOJI = {
  "–ö–æ—Ñ–µ":"‚òï","–†–µ—Å—Ç–æ—Ä–∞–Ω—ã":"üçΩ","–ë–∞—Ä—ã":"üç∏","–ö–∞–ª—å—è–Ω":"üí®",
  "–°–ø–æ—Ä—Ç":"üéæ","–†–∞–±–æ—Ç–∞":"üíº","–ú–∞–≥–∞–∑–∏–Ω":"üõí","–ò–≤–µ–Ω—Ç—ã":"üéâ","–£—Å–ª—É–≥–∏":"üß∞","–î–µ—Ç–∏":"üßí"
};
function makePinHtml(p){
  const e = CAT_EMOJI[p.category] || "üìç";
  const name = p.name || "–ú–µ—Å—Ç–æ";
  return `<div class="pinwrap"><span class="pin-emoji">${e}</span><span class="pin-name">${name}</span></div>`;
}

function addMarkers(){
  cluster.clearLayers(); labelLayer.clearLayers();

  (window.PLACES||[]).forEach(p=>{
    // –æ–±—ã—á–Ω—ã–π –º–∞—Ä–∫–µ—Ä (–¥–ª—è –ø–æ–ø–∞–ø–∞)
    const m = L.marker([p.lat, p.lng]);
    m.bindPopup(`
      <div style="width:240px">
        <img src="${p.photo_url||'https://picsum.photos/seed/spot/600/400'}" style="width:100%;height:140px;object-fit:cover;border-radius:6px;margin-bottom:6px"/>
        <div style="font-weight:700">${p.name||'–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}</div>
        <div style="font-size:12px;color:#888">${(p.subtype||p.category||'–ú–µ—Å—Ç–æ')} ‚Ä¢ ${p.neighborhood||''}</div>
        <div style="margin-top:6px;font-size:12px;background:#f3f3f3;border-radius:10px;display:inline-block;padding:2px 6px">–†—É—Å—Å–∫–∏—Ö: ${(p.russian_score||0)}/5</div>
        <div style="font-size:12px;color:#666">–ü–∏–∫: ${p.peak_hours||'‚Äî'}</div>
      </div>
    `);
    cluster.addLayer(m);

    // ¬´–Ω–∞–¥–ø–∏—Å—å-–ø–∏–Ω¬ª ‚Äî –∫–ª–∏–∫–∏ –Ω–µ –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç, –ø—Ä–æ—Å—Ç–æ –∫—Ä–∞—Å–∏–≤–æ –ø–æ–¥–ø–∏—Å—ã–≤–∞–µ—Ç
    const icon = L.divIcon({className:'', html: makePinHtml(p)});
    L.marker([p.lat, p.lng], {icon, interactive:false}).addTo(labelLayer);
  });

  map.addLayer(cluster);
}
addMarkers();

// Heatmap
let heatLayer=null;
document.getElementById('heat').onclick = (ev)=>{
  if(!heatLayer){
    const pts = (window.PLACES||[]).map(p=>[p.lat, p.lng, Math.max(0,Math.min(1,(p.russian_score||0)/5))]);
    heatLayer = L.heatLayer(pts, {radius:28, blur:18, maxZoom:15});
    heatLayer.addTo(map);
    ev.target.classList.add('active');
  } else {
    if(map.hasLayer(heatLayer)){ map.removeLayer(heatLayer); ev.target.classList.remove('active'); }
    else { heatLayer.addTo(map); ev.target.classList.add('active'); }
  }
};

// Route friday
let line=null;
document.getElementById('route').onclick = (ev)=>{
  const ids = (window.ROUTES && window.ROUTES.friday)||[];
  const pts = ids.map(id => (window.PLACES||[]).find(p=>p.id===id)).filter(Boolean).map(p=>[p.lat,p.lng]);
  if(!pts.length){ alert('–ú–∞—Ä—à—Ä—É—Ç –ø—è—Ç–Ω–∏—Ü—ã –ø—É—Å—Ç.'); return; }
  if(line){ if(map.hasLayer(line)){ map.removeLayer(line); ev.target.classList.remove('active'); return; } }
  line = L.polyline(pts, {color:'#0b57d0', weight:4, opacity:0.9}).addTo(map);
  map.fitBounds(line.getBounds().pad(0.2));
  ev.target.classList.add('active');
};
</script>
</body>
</html>
