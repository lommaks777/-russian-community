<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Browser Tests - Russian Community Map</title>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #0f0f0f;
            color: #eee;
        }
        .test-section {
            background: #121212;
            border: 1px solid #222;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .test-result {
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
        }
        .test-pass {
            background: #1a4d1a;
            border: 1px solid #2d5a2d;
        }
        .test-fail {
            background: #4d1a1a;
            border: 1px solid #5a2d2d;
        }
        button {
            background: #0b57d0;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0d4bb8;
        }
        #results {
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <h1>üß™ Browser Tests - Russian Community Map</h1>
    
    <div class="test-section">
        <h2>–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–π –∫–∞—Ä—Ç—ã</h2>
        <button onclick="testMapFunctions()">–ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã –∫–∞—Ä—Ç—ã</button>
        <div id="map-results"></div>
    </div>
    
    <div class="test-section">
        <h2>–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–π —Å–æ–±—ã—Ç–∏–π</h2>
        <button onclick="testEventFunctions()">–ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã —Å–æ–±—ã—Ç–∏–π</button>
        <div id="event-results"></div>
    </div>
    
    <div class="test-section">
        <h2>–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–π —Ñ–æ—Ä–º—ã</h2>
        <button onclick="testFormFunctions()">–ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã —Ñ–æ—Ä–º—ã</button>
        <div id="form-results"></div>
    </div>
    
    <div class="test-section">
        <h2>–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ç–µ–∫—Å—Ç–∞</h2>
        <button onclick="testTextProcessing()">–ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã —Ç–µ–∫—Å—Ç–∞</button>
        <div id="text-results"></div>
    </div>
    
    <div class="test-section">
        <h2>–í—Å–µ —Ç–µ—Å—Ç—ã</h2>
        <button onclick="runAllBrowserTests()">–ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ —Ç–µ—Å—Ç—ã</button>
        <div id="all-results"></div>
    </div>

    <script>
        // –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
        const mockEvents = [
            {
                id: "event1",
                title: "–ö–æ–Ω—Ü–µ—Ä—Ç —Ä—É—Å—Å–∫–æ–π –º—É–∑—ã–∫–∏",
                description: "–í–µ—á–µ—Ä —Ä—É—Å—Å–∫–æ–π –º—É–∑—ã–∫–∏ –≤ —Ü–µ–Ω—Ç—Ä–µ –ë—É—ç–Ω–æ—Å-–ê–π—Ä–µ—Å–∞",
                url: "https://example.com/event1",
                start: new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString(),
                end: new Date(Date.now() + 24 * 60 * 60 * 1000 + 3 * 60 * 60 * 1000).toISOString(),
                venue: { name: "Teatro Col√≥n", address: "Cerrito 628, C1010 Cdad. Aut√≥noma de Buenos Aires" },
                location: { lat: -34.6037, lng: -58.3816 },
                tags: ["–º—É–∑—ã–∫–∞", "–∫–æ–Ω—Ü–µ—Ä—Ç", "—Ä—É—Å—Å–∫–æ—è–∑—ã—á–Ω–æ–µ"],
                price: { is_free: false, text: "ARS 5000" }
            },
            {
                id: "event2",
                title: "–ë–µ—Å–ø–ª–∞—Ç–Ω–∞—è —è—Ä–º–∞—Ä–∫–∞ –¥–ª—è –¥–µ—Ç–µ–π",
                description: "–°–µ–º–µ–π–Ω–∞—è —è—Ä–º–∞—Ä–∫–∞ —Å —Ä–∞–∑–≤–ª–µ—á–µ–Ω–∏—è–º–∏ –¥–ª—è –¥–µ—Ç–µ–π",
                url: "https://example.com/event2",
                start: new Date(Date.now() + 2 * 24 * 60 * 60 * 1000).toISOString(),
                end: new Date(Date.now() + 2 * 24 * 60 * 60 * 1000 + 4 * 60 * 60 * 1000).toISOString(),
                venue: { name: "Parque Las Heras", address: "French, C1425 Cdad. Aut√≥noma de Buenos Aires" },
                location: { lat: -34.5838884, lng: -58.408831899999996 },
                tags: ["—è—Ä–º–∞—Ä–∫–∞", "–¥–µ—Ç—è–º", "–±–µ—Å–ø–ª–∞—Ç–Ω–æ"],
                price: { is_free: true, text: "–ë–µ—Å–ø–ª–∞—Ç–Ω–æ" }
            }
        ];

        // –§—É–Ω–∫—Ü–∏–∏ –∏–∑ –ø—Ä–æ–µ–∫—Ç–∞ (–∫–æ–ø–∏–∏ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
        function withKeyForPlacesMedia(url) {
            if (!url) return "";
            try {
                const u = new URL(url);
                if (u.hostname === "places.googleapis.com" && u.pathname.includes("/v1/") && u.pathname.endsWith("/media")) {
                    if (!u.searchParams.has("key")) u.searchParams.set("key", "AIzaSyB7-RgotVuWFR6qMvr_Alf8nQvkYd7I3WI");
                    return u.toString();
                }
            } catch {}
            return url;
        }

        function emojiFor(event) {
            const TAG_EMOJI = { 
                –º—É–∑—ã–∫–∞: "üéµ", –∫–æ–Ω—Ü–µ—Ä—Ç: "üé§", —è—Ä–º–∞—Ä–∫–∞: "üõçÔ∏è", –≤–µ—á–µ—Ä–∏–Ω–∫–∞: "üéâ", 
                –∫–∏–Ω–æ: "üé¨", —Ç–µ–∞—Ç—Ä: "üé≠", –±–µ—Å–ø–ª–∞—Ç–Ω–æ: "üÜì", –¥–µ—Ç—è–º: "üë∂", 
                —Ä—É—Å—Å–∫–æ—è–∑—ã—á–Ω–æ–µ: "üá∑üá∫" 
            };
            if (event.tags?.length) {
                for (const t of event.tags) {
                    if (TAG_EMOJI[t]) return TAG_EMOJI[t];
                }
            }
            return "üéüÔ∏è";
        }

        function whenText(event) {
            const start = new Date(event.start);
            const end = new Date(event.end || event.start);
            const sameDay = start.toDateString() === end.toDateString();
            const d = start.toLocaleDateString('ru-RU', { day: '2-digit', month: 'short', year: 'numeric' });
            const t1 = start.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
            const t2 = end.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
            return sameDay ? `${d}, ${t1}${event.end ? '‚Äì' + t2 : ''}` : `${d}, ${t1} ‚Üí ${end.toLocaleString('ru-RU', { day: '2-digit', month: 'short' })} ${t2}`;
        }

        function upcomingOnly(events) {
            const now = Date.now();
            return events.filter(e => new Date(e.end || e.start).getTime() >= now);
        }

        function filtered(events, tagFilter, priceFilter, query) {
            return upcomingOnly(events || []).filter(e => {
                const byTag = !tagFilter || (e.tags || []).includes(tagFilter);
                const byPrice = !priceFilter || (priceFilter === 'free' ? e.price?.is_free : !e.price?.is_free);
                const byQuery = !query || (e.title || '').toLowerCase().includes(query);
                return byTag && byPrice && byQuery;
            }).sort((a, b) => new Date(a.start) - new Date(b.start));
        }

        const TAG_RULES = [
            { tag: '–º—É–∑—ã–∫–∞', rx: /\b(music|m√∫sica|musica|dj|band|live|recital)\b/i },
            { tag: '–∫–æ–Ω—Ü–µ—Ä—Ç', rx: /\b(concert|recital|gig)\b/i },
            { tag: '—è—Ä–º–∞—Ä–∫–∞', rx: /\b(fair|feria|market|mercado|—è—Ä–º–∞—Ä–∫–∞)\b/i },
            { tag: '–≤–µ—á–µ—Ä–∏–Ω–∫–∞', rx: /\b(party|fiesta|rave)\b/i },
            { tag: '–∫–∏–Ω–æ', rx: /\b(cinema|cine|film|pel[i√≠]cula|–∫–∏–Ω–æ)\b/i },
            { tag: '—Ç–µ–∞—Ç—Ä', rx: /\b(theatre|teatro)\b/i },
            { tag: '–¥–µ—Ç—è–º', rx: /\b(kids|ni√±|infantil|–¥–µ—Ç(—è–º|–∏))\b/i },
            { tag: '—Ä—É—Å—Å–∫–æ—è–∑—ã—á–Ω–æ–µ', rx: /\b(rus|ruso|rusa|—Ä—É—Å—Å–∫|russian)\b/i },
            { tag: '–±–µ—Å–ø–ª–∞—Ç–Ω–æ', rx: /\b(free|gratis|gratuito|–±–µ—Å–ø–ª–∞—Ç)/i }
        ];

        function tagify(text) {
            const tags = [];
            for (const r of TAG_RULES) {
                if (r.rx.test(text || '')) tags.push(r.tag);
            }
            return [...new Set(tags)];
        }

        function priceFrom(text) {
            if (!text) return { is_free: false, text: '' };
            if (/\b(free|gratis|gratuito|–±–µ—Å–ø–ª–∞—Ç)/i.test(text)) return { is_free: true, text: '–ë–µ—Å–ø–ª–∞—Ç–Ω–æ' };
            const m = text.match(/(?:ARS|\$|usd|u\$s)\s?\d[\d.,]*/i);
            return { is_free: false, text: m ? m[0].replace(/usd/i, 'USD').replace(/u\$s/i, 'USD') : '' };
        }

        // –£—Ç–∏–ª–∏—Ç—ã –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        function addResult(containerId, testName, passed, message) {
            const container = document.getElementById(containerId);
            const div = document.createElement('div');
            div.className = `test-result ${passed ? 'test-pass' : 'test-fail'}`;
            div.innerHTML = `${passed ? '‚úÖ' : '‚ùå'} ${testName}: ${message}`;
            container.appendChild(div);
        }

        function clearResults(containerId) {
            document.getElementById(containerId).innerHTML = '';
        }

        // –¢–µ—Å—Ç—ã —Ñ—É–Ω–∫—Ü–∏–π –∫–∞—Ä—Ç—ã
        function testMapFunctions() {
            clearResults('map-results');
            
            // –¢–µ—Å—Ç withKeyForPlacesMedia
            const urlWithoutKey = "https://places.googleapis.com/v1/places/ChIJTest/photos/ATKogpe/media?maxWidthPx=800";
            const result1 = withKeyForPlacesMedia(urlWithoutKey);
            addResult('map-results', 'withKeyForPlacesMedia - –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–ª—é—á–∞', result1.includes('key='), 
                result1.includes('key=') ? '–ö–ª—é—á –¥–æ–±–∞–≤–ª–µ–Ω' : '–ö–ª—é—á –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω');
            
            const urlWithKey = "https://places.googleapis.com/v1/places/ChIJTest/photos/ATKogpe/media?maxWidthPx=800&key=test";
            const result2 = withKeyForPlacesMedia(urlWithKey);
            addResult('map-results', 'withKeyForPlacesMedia - URL —Å –∫–ª—é—á–æ–º', result2 === urlWithKey, 
                result2 === urlWithKey ? 'URL –Ω–µ –∏–∑–º–µ–Ω–µ–Ω' : 'URL –∏–∑–º–µ–Ω–µ–Ω');
            
            const emptyUrl = withKeyForPlacesMedia("");
            addResult('map-results', 'withKeyForPlacesMedia - –ø—É—Å—Ç–æ–π URL', emptyUrl === "", 
                emptyUrl === "" ? '–ü—É—Å—Ç–æ–π URL –æ–±—Ä–∞–±–æ—Ç–∞–Ω' : '–û—à–∏–±–∫–∞ —Å –ø—É—Å—Ç—ã–º URL');
        }

        // –¢–µ—Å—Ç—ã —Ñ—É–Ω–∫—Ü–∏–π —Å–æ–±—ã—Ç–∏–π
        function testEventFunctions() {
            clearResults('event-results');
            
            // –¢–µ—Å—Ç emojiFor
            const eventWithTags = { tags: ['–º—É–∑—ã–∫–∞', '–∫–æ–Ω—Ü–µ—Ä—Ç'] };
            const emoji1 = emojiFor(eventWithTags);
            addResult('event-results', 'emojiFor - —Å–æ–±—ã—Ç–∏–µ —Å —Ç–µ–≥–∞–º–∏', emoji1 === 'üéµ', 
                emoji1 === 'üéµ' ? '–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π —ç–º–æ–¥–∑–∏' : `–ü–æ–ª—É—á–µ–Ω: ${emoji1}`);
            
            const eventWithoutTags = { tags: [] };
            const emoji2 = emojiFor(eventWithoutTags);
            addResult('event-results', 'emojiFor - —Å–æ–±—ã—Ç–∏–µ –±–µ–∑ —Ç–µ–≥–æ–≤', emoji2 === 'üéüÔ∏è', 
                emoji2 === 'üéüÔ∏è' ? '–≠–º–æ–¥–∑–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é' : `–ü–æ–ª—É—á–µ–Ω: ${emoji2}`);
            
            // –¢–µ—Å—Ç whenText
            const event = mockEvents[0];
            const when = whenText(event);
            addResult('event-results', 'whenText - —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏', when.includes(':'), 
                when.includes(':') ? '–í—Ä–µ–º—è –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–æ' : '–û—à–∏–±–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è');
            
            // –¢–µ—Å—Ç upcomingOnly
            const upcoming = upcomingOnly(mockEvents);
            addResult('event-results', 'upcomingOnly - —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è', upcoming.length === 2, 
                upcoming.length === 2 ? '–ë—É–¥—É—â–∏–µ —Å–æ–±—ã—Ç–∏—è –Ω–∞–π–¥–µ–Ω—ã' : `–ù–∞–π–¥–µ–Ω–æ: ${upcoming.length}`);
            
            // –¢–µ—Å—Ç filtered
            const musicEvents = filtered(mockEvents, '–º—É–∑—ã–∫–∞', '', '');
            addResult('event-results', 'filtered - —Ñ–∏–ª—å—Ç—Ä –ø–æ —Ç–µ–≥—É', musicEvents.length === 1, 
                musicEvents.length === 1 ? '–§–∏–ª—å—Ç—Ä –ø–æ —Ç–µ–≥—É —Ä–∞–±–æ—Ç–∞–µ—Ç' : `–ù–∞–π–¥–µ–Ω–æ: ${musicEvents.length}`);
            
            const freeEvents = filtered(mockEvents, '', 'free', '');
            addResult('event-results', 'filtered - —Ñ–∏–ª—å—Ç—Ä –ø–æ —Ü–µ–Ω–µ', freeEvents.length === 1, 
                freeEvents.length === 1 ? '–§–∏–ª—å—Ç—Ä –ø–æ —Ü–µ–Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç' : `–ù–∞–π–¥–µ–Ω–æ: ${freeEvents.length}`);
        }

        // –¢–µ—Å—Ç—ã —Ñ—É–Ω–∫—Ü–∏–π —Ñ–æ—Ä–º—ã
        function testFormFunctions() {
            clearResults('form-results');
            
            const mockFormData = {
                name: "Test Place",
                category: "–ö–æ—Ñ–µ",
                lat: "-34.6037",
                lng: "-58.3816",
                neighborhood: "Palermo",
                rus: "3"
            };
            
            function buildJson(formData) {
                return {
                    id: Date.now(),
                    name: formData.name?.trim() || '',
                    category: formData.category || '',
                    lat: Number(formData.lat) || 0,
                    lng: Number(formData.lng) || 0,
                    neighborhood: formData.neighborhood?.trim() || '',
                    russian_score: Number(formData.rus) || 0
                };
            }
            
            const json = buildJson(mockFormData);
            addResult('form-results', 'buildJson - —Å–æ–∑–¥–∞–Ω–∏–µ JSON', json.name === 'Test Place', 
                json.name === 'Test Place' ? 'JSON —Å–æ–∑–¥–∞–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ' : '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è JSON');
            
            addResult('form-results', 'buildJson - —á–∏—Å–ª–æ–≤—ã–µ –ø–æ–ª—è', json.lat === -34.6037, 
                json.lat === -34.6037 ? '–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ' : `–ü–æ–ª—É—á–µ–Ω–æ: ${json.lat}`);
            
            addResult('form-results', 'buildJson - ID', typeof json.id === 'number', 
                typeof json.id === 'number' ? 'ID —á–∏—Å–ª–æ–≤–æ–π' : 'ID –Ω–µ —á–∏—Å–ª–æ–≤–æ–π');
        }

        // –¢–µ—Å—Ç—ã –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ç–µ–∫—Å—Ç–∞
        function testTextProcessing() {
            clearResults('text-results');
            
            // –¢–µ—Å—Ç tagify
            const text1 = 'Concert de m√∫sica rusa en Buenos Aires';
            const tags1 = tagify(text1);
            addResult('text-results', 'tagify - –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–µ–≥–æ–≤', tags1.includes('–º—É–∑—ã–∫–∞'), 
                tags1.includes('–º—É–∑—ã–∫–∞') ? '–¢–µ–≥–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã' : `–¢–µ–≥–∏: ${tags1.join(', ')}`);
            
            const text2 = 'Free kids party with live music';
            const tags2 = tagify(text2);
            addResult('text-results', 'tagify - –∞–Ω–≥–ª–∏–π—Å–∫–∏–π —Ç–µ–∫—Å—Ç', tags2.includes('–±–µ—Å–ø–ª–∞—Ç–Ω–æ'), 
                tags2.includes('–±–µ—Å–ø–ª–∞—Ç–Ω–æ') ? '–ê–Ω–≥–ª–∏–π—Å–∫–∏–µ —Ç–µ–≥–∏ –Ω–∞–π–¥–µ–Ω—ã' : `–¢–µ–≥–∏: ${tags2.join(', ')}`);
            
            // –¢–µ—Å—Ç priceFrom
            const freeText = 'Evento gratuito para toda la familia';
            const price1 = priceFrom(freeText);
            addResult('text-results', 'priceFrom - –±–µ—Å–ø–ª–∞—Ç–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ', price1.is_free, 
                price1.is_free ? '–ë–µ—Å–ø–ª–∞—Ç–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ' : '–û—à–∏–±–∫–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ü–µ–Ω—ã');
            
            const paidText = 'Entrada: ARS 5000 por persona';
            const price2 = priceFrom(paidText);
            addResult('text-results', 'priceFrom - –ø–ª–∞—Ç–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ', !price2.is_free, 
                !price2.is_free ? '–ü–ª–∞—Ç–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ' : '–û—à–∏–±–∫–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ü–µ–Ω—ã');
        }

        // –ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤
        function runAllBrowserTests() {
            clearResults('all-results');
            addResult('all-results', '–ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤', true, '–ù–∞—á–∏–Ω–∞–µ–º —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ...');
            
            testMapFunctions();
            testEventFunctions();
            testFormFunctions();
            testTextProcessing();
            
            addResult('all-results', '–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤', true, '–í—Å–µ —Ç–µ—Å—Ç—ã –∑–∞–≤–µ—Ä—à–µ–Ω—ã');
        }
    </script>
</body>
</html>

