<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Добавить место — Русская карта БА</title>
  <style>
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:#0f0f0f;color:#eee}
    header{padding:12px;border-bottom:1px solid #222;background:#111;display:flex;gap:10px;align-items:center}
    header a{color:#9ecbff;text-decoration:none}
    main{max-width:840px;margin:20px auto;padding:0 16px}
    .card{background:#121212;border:1px solid #222;border-radius:12px;padding:16px;margin-bottom:16px}
    label{font-size:13px;color:#aaa;display:block;margin-bottom:4px}
    input,select,textarea{width:100%;padding:10px;border-radius:8px;border:1px solid #2a2a2a;background:#181818;color:#eee}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
    button{padding:10px 14px;border-radius:10px;border:1px solid #2a2a2a;background:#1f1f1f;color:#eee;cursor:pointer}
    .btn-primary{background:#0b57d0;border-color:#0b57d0}
    .muted{font-size:12px;color:#888}
    .hint{font-size:12px;color:#bbb;margin-top:6px}
    .ok{color:#7bd88f;font-weight:600}
  </style>
</head>
<body>
<header>
  <div><a href="./">← Назад к карте</a></div>
  <div style="flex:1"></div>
  <div>Шаги: 1) Вставь ссылку Google Maps или название → 2) Найти → 3) Проверить → 4) Отправить</div>
</header>
<main>
  <div class="card">
    <div class="row">
      <div>
        <label>Ссылка Google Maps или название места</label>
        <input id="query" placeholder="Вставь ссылку или введи название и район (например, 'Padel Palermo')" />
        <div class="hint">Можно просто вставить «Поделиться» ссылку из Google Maps.</div>
      </div>
      <div>
        <label>Категория</label>
        <select id="category">
          <option>Кофе</option><option>Рестораны</option><option>Бары</option>
          <option>Кальян</option><option>Спорт</option><option>Работа</option>
          <option>Магазин</option><option>Ивенты</option><option>Услуги</option><option>Дети</option>
        </select>
      </div>
    </div>
    <div class="row">
      <div>
        <label>Подтип (опционально)</label>
        <input id="subtype" placeholder="Спешиалти, падел, лаунж..." />
      </div>
      <div>
        <label>Плотность русских (0–5)</label>
        <input id="rus" type="number" min="0" max="5" step="1" value="3"/>
      </div>
    </div>
    <div class="row3" style="margin-top:8px">
      <div><button id="btnFind" class="btn-primary">Найти в Google</button></div>
      <div><button id="btnPreview">Предпросмотр</button></div>
      <div><button id="btnSubmit" class="btn-primary">Отправить в GitHub</button></div>
    </div>
    <div id="status" class="hint" style="margin-top:10px"></div>
  </div>

  <div class="card">
    <div class="row">
      <div><label>Название</label><input id="name" /></div>
      <div><label>Район</label><input id="neighborhood" placeholder="Palermo, Belgrano, Recoleta..." /></div>
    </div>
    <div class="row">
      <div><label>Адрес</label><input id="address" /></div>
      <div><label>Пик посещений</label><input id="peak" placeholder="Пт–Сб 21–01, Сб 12–16..." /></div>
    </div>
    <div class="row">
      <div><label>Instagram</label><input id="insta" placeholder="https://instagram.com/..." /></div>
      <div><label>Сайт</label><input id="site" placeholder="https://..." /></div>
    </div>
    <div class="row">
      <div><label>Телефон</label><input id="phone" placeholder="+54..." /></div>
      <div><label>Фото (кастомная обложка, опц.)</label><input id="photo" placeholder="https://..." /></div>
    </div>
    <div class="row">
      <div><label>lat</label><input id="lat" /></div>
      <div><label>lng</label><input id="lng" /></div>
    </div>
    <div class="row">
      <div><label>place_id (заполняется автоматически)</label><input id="placeid" /></div>
      <div><label>Заметка (опционально)</label><input id="notes" /></div>
    </div>
    <div class="hint">Данные подтянутся из Google, но можно поправить вручную перед отправкой.</div>
  </div>

  <div class="card">
    <label>Сформированный JSON</label>
    <textarea id="json" rows="8" readonly></textarea>
    <div class="hint">Кнопка «Отправить в GitHub» откроет новый Issue с этим JSON — просто нажми Submit.</div>
  </div>
</main>

<script>
const GOOGLE_KEY = "YOUR_GOOGLE_MAPS_API_KEY_HERE";
let mapSvc;

// подгружаем библиотеку Maps JS (только places)
(function(){
  const s = document.createElement('script');
  s.src = `https://maps.googleapis.com/maps/api/js?key=${encodeURIComponent(GOOGLE_KEY)}&libraries=places&v=weekly&callback=_init`;
  s.async = true; document.head.appendChild(s);
})();
window._init = function(){
  const dummyMap = document.createElement('div'); // сервису нужен контекст карты, но карта нам не нужна
  dummyMap.style.display='none'; document.body.appendChild(dummyMap);
  const map = new google.maps.Map(dummyMap, {center:{lat:-34.6037,lng:-58.3816},zoom:12});
  mapSvc = new google.maps.places.PlacesService(map);
}

const $ = id => document.getElementById(id);
const setStatus = (t, ok=false)=> { $('status').innerHTML = ok? `<span class="ok">${t}</span>` : t; };

$('btnFind').onclick = async ()=>{
  const q = $('query').value.trim();
  if(!q){ setStatus('Вставь ссылку или введи название.'); return; }
  setStatus('Ищу в Google…');

  // 1) пытаемся вытащить place_id из ссылки (если это share-url вида ...?q=place_id:XXXX)
  const pid = extractPlaceId(q);
  if (pid) {
    fetchDetailsByPlaceId(pid);
    return;
  }

  // 2) иначе FindPlace по тексту
  mapSvc.findPlaceFromQuery({
    query: q,
    fields: ['place_id','name','geometry','formatted_address']
  }, (res, status)=>{
    if (status === google.maps.places.PlacesServiceStatus.OK && res && res.length){
      const it = res[0];
      $('placeid').value = it.place_id || '';
      $('name').value = it.name || '';
      $('address').value = it.formatted_address || '';
      if (it.geometry && it.geometry.location){
        $('lat').value = it.geometry.location.lat();
        $('lng').value = it.geometry.location.lng();
      }
      // тянем дополнительные поля
      fetchDetailsByPlaceId(it.place_id);
    } else {
      setStatus('Не нашёл по запросу. Попробуй другое название или укажи район.', false);
    }
  });
};

function extractPlaceId(url){
  try {
    const u = new URL(url);
    // варианты:
    // ...?q=place_id:ChIJ...  или  .../place/?q=place_id:ChIJ...
    const q = u.searchParams.get('q');
    if (q && q.startsWith('place_id:')) return q.split('place_id:')[1];
    // иногда place_id встречается в path:
    const m = url.match(/place_id:([A-Za-z0-9_-]+)/);
    if (m) return m[1];
  } catch(e){}
  return null;
}

function fetchDetailsByPlaceId(pid){
  mapSvc.getDetails({
    placeId: pid,
    fields: [
      'name','rating','user_ratings_total','photos','website',
      'international_phone_number','url','geometry','formatted_address','address_components'
    ]
  }, (d, status)=>{
    if (status === google.maps.places.PlacesServiceStatus.OK && d){
      $('placeid').value = d.place_id || '';
      $('name').value = d.name || $('name').value;
      $('address').value = d.formatted_address || $('address').value;
      if (d.geometry && d.geometry.location){
        $('lat').value = d.geometry.location.lat();
        $('lng').value = d.geometry.location.lng();
      }
      // извлекаем район (sublocality, neighborhood)
      const comp = (d.address_components||[]).find(c=>c.types.includes('sublocality')||c.types.includes('neighborhood'));
      if (comp && !$('neighborhood').value) $('neighborhood').value = comp.long_name;

      // если нет кастомной обложки — поставим первую фотку
      if (!$('photo').value && d.photos && d.photos.length){
        $('photo').value = d.photos[0].getUrl({maxWidth:800,maxHeight:600});
      }
      // телефон/сайт
      if (d.international_phone_number && !$('phone').value) $('phone').value = d.international_phone_number;
      if (d.website && !$('site').value) $('site').value = d.website;

      setStatus('Нашёл! Данные подтянулись. Проверь и отправляй.', true);
      buildJsonPreview();
    } else {
      setStatus('Не удалось получить детали по place_id.', false);
    }
  });
}

$('btnPreview').onclick = buildJsonPreview;

function buildJsonPreview(){
  const obj = {
    id: Date.now(), // временный id — ты потом не используешь его напрямую
    name: $('name').value.trim(),
    category: $('category').value,
    subtype: $('subtype').value.trim(),
    lat: Number($('lat').value),
    lng: Number($('lng').value),
    neighborhood: $('neighborhood').value.trim(),
    russian_score: Number($('rus').value||0),
    peak_hours: $('peak').value.trim(),
    instagram: $('insta').value.trim(),
    website: $('site').value.trim(),
    phone: $('phone').value.trim(),
    photo_url: $('photo').value.trim(),
    address: $('address').value.trim(),
    place_id: $('placeid').value.trim(),
    notes: $('notes').value.trim()
  };
  $('json').value = JSON.stringify(obj, null, 2);
  setStatus('Готов предварительный JSON. Нажми «Отправить в GitHub».', true);
  return obj;
}

$('btnSubmit').onclick = ()=>{
  const obj = buildJsonPreview();
  // собираем ссылку «создать issue» в твоём репозитории:
  const repo = "lommaks777/-russian-community";
  const title = encodeURIComponent("Новая точка: " + (obj.name||"без названия"));
  const body = encodeURIComponent([
    "Пожалуйста, проверь и добавь в data/places.js",
    "",
    "```json",
    JSON.stringify(obj, null, 2),
    "```"
  ].join("\n"));
  const url = `https://github.com/${repo}/issues/new?title=${title}&body=${body}`;
  window.open(url, "_blank");
};
</script>
</body>
</html>
