<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Добавить место — Русская карта БА</title>
  <style>
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:#0f0f0f;color:#eee}
    header{padding:12px;border-bottom:1px solid #222;background:#111;display:flex;gap:10px;align-items:center}
    header a{color:#9ecbff;text-decoration:none}
    main{max-width:920px;margin:20px auto;padding:0 16px}
    .card{background:#121212;border:1px solid #222;border-radius:12px;padding:16px;margin-bottom:16px}
    label{font-size:13px;color:#aaa;display:block;margin-bottom:4px}
    input,select,textarea{width:100%;padding:10px;border-radius:8px;border:1px solid #2a2a2a;background:#181818;color:#eee}
    textarea{min-height:220px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
    button{padding:10px 14px;border-radius:10px;border:1px solid #2a2a2a;background:#1f1f1f;color:#eee;cursor:pointer}
    .btn-primary{background:#0b57d0;border-color:#0b57d0}
    .hint{font-size:12px;color:#bbb;margin-top:6px}
    .ok{color:#7bd88f;font-weight:600}
    /* тёмная тема выпадашки автокомплита */
    .pac-container{background:#222!important;color:#eee!important;border:1px solid #333!important;border-radius:8px!important}
    .pac-item{color:#eee!important;padding:6px 10px!important}
    .pac-item:hover{background:#333!important}
    .pac-item-query{color:#fff!important}
  </style>
</head>
<body>
<header>
  <div><a href="./">← Назад к карте</a></div>
  <div style="flex:1"></div>
  <div>Введи название → выбери из списка <b>или</b> нажми «Найти по названию» → Предпросмотр → Отправить</div>
</header>

<main>
  <div class="card">
    <div class="row">
      <div>
        <label>Название или длинная ссылка Google Maps</label>
        <input id="query" type="text" autocomplete="off" placeholder="Например: Buró Árbol Palermo, 'чайхана', 'Buro Arbol'"/>
        <div class="hint">Короткие ссылки <code>maps.app.goo.gl</code> сначала открой и скопируй длинный URL из адресной строки — либо просто пользуйся поиском.</div>
      </div>
      <div>
        <label>Категория</label>
        <select id="category">
          <option>Кофе</option><option>Рестораны</option><option>Бары</option>
          <option>Кальян</option><option>Спорт</option><option>Работа</option>
          <option>Магазин</option><option>Ивенты</option><option>Услуги</option><option>Дети</option>
        </select>
      </div>
    </div>
    <div class="row3" style="margin-top:8px">
      <div><button id="btnSearch" class="btn-primary">Найти по названию</button></div>
      <div><button id="btnParse">Заполнить из ссылки</button></div>
      <div><button id="btnPreview">Предпросмотр</button></div>
    </div>
    <div style="margin-top:8px" class="row3">
      <div><button id="btnSubmit" class="btn-primary">Отправить в GitHub</button></div>
      <div><span id="status" class="hint"></span></div>
      <div></div>
    </div>
  </div>

  <div class="card">
    <div class="row">
      <div><label>Название</label><input id="name"/></div>
      <div><label>Район</label><input id="neighborhood"/></div>
    </div>
    <div class="row">
      <div><label>Адрес</label><input id="address"/></div>
      <div><label>Пик посещений</label><input id="peak"/></div>
    </div>
    <div class="row">
      <div><label>Instagram</label><input id="insta"/></div>
      <div><label>Сайт</label><input id="site"/></div>
    </div>
    <div class="row">
      <div><label>Телефон</label><input id="phone"/></div>
      <div><label>Фото (URL)</label><input id="photo"/></div>
    </div>
    <div class="row">
      <div><label>lat</label><input id="lat"/></div>
      <div><label>lng</label><input id="lng"/></div>
    </div>
    <div class="row">
      <div><label>place_id</label><input id="placeid"/></div>
      <div><label>Плотность русских (0–5)</label><input id="rus" type="number" min="0" max="5" step="1" value="3"/></div>
    </div>
    <div class="row">
      <div><label>Заметка</label><input id="notes"/></div>
      <div></div>
    </div>
  </div>

  <div class="card">
    <label>JSON</label>
    <textarea id="json" rows="10" readonly></textarea>
  </div>
</main>

<script>
/* Ключ подставляется из GitHub Secrets в workflow. Для локальной проверки можно временно вставить реальный ключ. */
const GOOGLE_KEY = "__MAPS_PUBLIC_KEY__";

const $ = id => document.getElementById(id);
const setStatus = (t, ok=false)=> { $('status').innerHTML = ok? `<span class="ok">${t}</span>` : t; };
const BA = {lat:-34.6037, lng:-58.3816};

window.addEventListener('DOMContentLoaded', () => {
  const url = `https://maps.googleapis.com/maps/api/js?key=${encodeURIComponent(GOOGLE_KEY)}&libraries=places&language=ru&region=AR&v=weekly&loading=async&callback=initPlaces`;
  const s = document.createElement('script'); s.src=url; s.async=true; s.defer=true; document.head.appendChild(s);
});

let PlaceClass, AutocompleteClass, Token;

async function initPlaces(){
  const { Place, Autocomplete, AutocompleteSessionToken } = await google.maps.importLibrary("places");
  PlaceClass = Place; AutocompleteClass = Autocomplete; Token = new AutocompleteSessionToken();

  const input = $('query');
  if (!(input instanceof HTMLInputElement)) { setStatus('Ошибка: поле ввода не найдено.', false); return; }

  // Новый Autocomplete (JS SDK): используем ИМЕНА ПОЛЕЙ для JS-версии
  const ac = new AutocompleteClass(input, {
    fields: ["place_id","name","formatted_address","geometry","types"],
    bounds: {east:-58.30, west:-58.55, north:-34.50, south:-34.72},
    strictBounds: false
  });
  if (ac.setOptions) ac.setOptions({ sessionToken: Token });

  ac.addListener("place_changed", async ()=>{
    const lite = ac.getPlace();
    if (!lite || !lite.place_id){ setStatus("Выбери пункт из списка или нажми «Найти по названию»."); return; }
    await fetchPlaceById(lite.place_id);
  });

  // Enter запускает поиск по названию (если пользователь не выбирает из списка)
  input.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); $('btnSearch').click(); } });

  // Подсказка про секрет, если забыли подменить
  if (GOOGLE_KEY.startsWith('__MAPS_PUBLIC_KEY__')) {
    console.warn('⚠️ Похоже, секрет не подставился. Для проверки можно временно вставить реальный ключ в константу GOOGLE_KEY.');
  }

  setStatus('Начни вводить и выбери из подсказок, либо нажми «Найти по названию».', true);
}

/* Детали по place_id через JS SDK (старые названия полей) */
async function fetchPlaceById(pid){
  try{
    const place = new PlaceClass({ id: pid, requestedLanguage: 'ru' });
    await place.fetchFields({
      fields: ["place_id","name","formatted_address","geometry","international_phone_number","website","photos","address_components"],
      sessionToken: Token
    });

    fillFormFromJsPlace(place);
    setStatus('Данные подтянулись из подсказки.', true);
    buildJson();
  } catch(e){
    console.error(e);
    setStatus('Не удалось получить детали по месту.', false);
  }
}

function fillFormFromJsPlace(place){
  if (place.place_id) $('placeid').value = place.place_id;
  if (place.name && !$('name').value) $('name').value = place.name;
  if (place.formatted_address && !$('address').value) $('address').value = place.formatted_address;
  if (place.geometry?.location){
    $('lat').value = place.geometry.location.lat();
    $('lng').value = place.geometry.location.lng();
  }
  const comp = (place.address_components||[]).find(c => (c.types||[]).includes('sublocality') || (c.types||[]).includes('neighborhood'));
  if (comp?.long_name && !$('neighborhood').value) $('neighborhood').value = comp.long_name;

  if (place.international_phone_number && !$('phone').value) $('phone').value = place.international_phone_number;
  if (place.website && !$('site').value) $('site').value = place.website;
  if (!$('photo').value && place.photos?.length){
    try { $('photo').value = place.photos[0].getUrl({maxWidth:800,maxHeight:600}); } catch {}
  }
}

/* Кнопка «Найти по названию» — REST v1 (новые имена полей) */
$('btnSearch').onclick = async ()=>{
  const text = $('query').value.trim();
  if (text.length < 2){ setStatus('Введите название длиннее.', false); return; }
  setStatus('Ищу по названию…');
  try{
    const resp = await fetch(`https://places.googleapis.com/v1/places:searchText?key=${encodeURIComponent(GOOGLE_KEY)}`, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({
        textQuery:text,
        languageCode:'ru',
        locationBias:{circle:{center:{latitude:BA.lat,longitude:BA.lng},radius:50000}}
      })
    });
    const data = await resp.json();
    const p = (data.places||[])[0];
    if(!p){ setStatus('Ничего не найдено. Попробуйте точнее: название + район.', false); return; }
    fillFormFromRestPlace(p);
    setStatus('Нашёл и заполнил по названию.', true);
    buildJson();
  }catch(e){ console.error(e); setStatus('Поиск по названию не сработал.', false); }
};

function fillFormFromRestPlace(p){
  if (p.id) $('placeid').value = p.id;
  if ((p.displayName?.text || p.displayName) && !$('name').value) $('name').value = p.displayName.text || p.displayName;
  if (p.formattedAddress && !$('address').value) $('address').value = p.formattedAddress;
  if (p.location){ $('lat').value = p.location.latitude; $('lng').value = p.location.longitude; }
  const comp = (p.addressComponents||[]).find(c => (c.types||[]).includes('sublocality') || (c.types||[]).includes('neighborhood'));
  if (comp?.longText && !$('neighborhood').value) $('neighborhood').value = comp.longText;
  if (p.internationalPhoneNumber && !$('phone').value) $('phone').value = p.internationalPhoneNumber;
  if (p.websiteUri && !$('site').value) $('site').value = p.websiteUri;
  if (!$('photo').value && p.photos?.length && p.photos[0].name){
    $('photo').value = `https://places.googleapis.com/v1/${p.photos[0].name}/media?key=${encodeURIComponent(GOOGLE_KEY)}&maxWidthPx=800`;
  }
}

/* Парс длинного URL (fallback) */
$('btnParse').onclick = ()=>{
  const raw = $('query').value.trim();
  if(!raw){ setStatus('Вставь длинный URL или пользуйся поиском.', false); return; }
  try{
    const url = new URL(raw);
    const path = decodeURIComponent(url.pathname);
    const name = path.split('/place/')[1]?.split('/')[0]?.replace(/\+/g,' ').replace(/_/g,' ') || '';
    if (name && !$('name').value) $('name').value = name;

    const at = raw.match(/@(-?\d+\.\d+),(-?\d+\.\d+)/);
    if (at){ $('lat').value = at[1]; $('lng').value = at[2]; }

    const pidMatch = raw.match(/place_id:([A-Za-z0-9_-]+)/i);
    if (pidMatch) $('placeid').value = pidMatch[1];

    setStatus('Заполнил из ссылки. Проверь и дополни.', true);
    buildJson();
  }catch{ setStatus('Не похоже на длинный URL Google Maps.', false); }
};

/* JSON и отправка */
function buildJson(){
  const o = {
    id: Date.now(),
    name: $('name').value.trim(),
    category: $('category').value,
    subtype: '',
    lat: Number($('lat').value),
    lng: Number($('lng').value),
    neighborhood: $('neighborhood').value.trim(),
    russian_score: Number($('rus').value||0),
    peak_hours: $('peak').value.trim(),
    instagram: $('insta').value.trim(),
    website: $('site').value.trim(),
    phone: $('phone').value.trim(),
    photo_url: $('photo').value.trim(),
    address: $('address').value.trim(),
    place_id: $('placeid').value.trim(),
    notes: $('notes').value.trim()
  };
  $('json').value = JSON.stringify(o, null, 2);
  return o;
}
$('btnPreview').onclick = ()=>{ buildJson(); setStatus('Предпросмотр готов.', true); };
$('btnSubmit').onclick = ()=>{
  const o = buildJson();
  if (!o.name || !o.lat || !o.lng){ setStatus('Нужно минимум: Название + координаты.', false); return; }
  const repo = "lommaks777/-russian-community";
  const title = encodeURIComponent("Новая точка: " + (o.name||"без названия"));
  const body = encodeURIComponent(["Проверь и добавь в data/places.js","","```json",JSON.stringify(o,null,2),"```"].join("\n"));
  window.open(`https://github.com/${repo}/issues/new?title=${title}&body=${body}`,"_blank");
};
</script>
</body>
</html>
