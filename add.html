<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Добавить место — Русская карта БА</title>
  <style>
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:#0f0f0f;color:#eee}
    header{padding:12px;border-bottom:1px solid #222;background:#111;display:flex;gap:10px;align-items:center}
    header a{color:#9ecbff;text-decoration:none}
    main{max-width:920px;margin:20px auto;padding:0 16px}
    .card{background:#121212;border:1px solid #222;border-radius:12px;padding:16px;margin-bottom:16px}
    label{font-size:13px;color:#aaa;display:block;margin-bottom:4px}
    input,select,textarea{width:100%;padding:10px;border-radius:8px;border:1px solid #2a2a2a;background:#181818;color:#eee}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
    button{padding:10px 14px;border-radius:10px;border:1px solid #2a2a2a;background:#1f1f1f;color:#eee;cursor:pointer}
    .btn-primary{background:#0b57d0;border-color:#0b57d0}
    .hint{font-size:12px;color:#bbb;margin-top:6px}
    .ok{color:#7bd88f;font-weight:600}
  </style>
</head>
<body>
<header>
  <div><a href="./">← Назад к карте</a></div>
  <div style="flex:1"></div>
  <div>Вставь ссылку или заполни вручную → Предпросмотр → Отправить</div>
</header>
<main>
  <div class="card">
    <div class="row">
      <div>
        <label>Ссылка Google Maps или название</label>
        <input id="query" placeholder="Вставь длинную ссылку Google Maps (из адресной строки) или заполни поля ниже"/>
        <div class="hint">Короткие ссылки <code>maps.app.goo.gl</code> нажми и раскрой в новой вкладке, затем скопируй длинный URL с адресной строки.</div>
      </div>
      <div>
        <label>Категория</label>
        <select id="category">
          <option>Кофе</option><option>Рестораны</option><option>Бары</option>
          <option>Кальян</option><option>Спорт</option><option>Работа</option>
          <option>Магазин</option><option>Ивенты</option><option>Услуги</option><option>Дети</option>
        </select>
      </div>
    </div>
    <div class="row3" style="margin-top:8px">
      <div><button id="btnParse" class="btn-primary">Заполнить из ссылки</button></div>
      <div><button id="btnPreview">Предпросмотр</button></div>
      <div><button id="btnSubmit" class="btn-primary">Отправить в GitHub</button></div>
    </div>
    <div id="status" class="hint" style="margin-top:10px"></div>
  </div>

  <div class="card">
    <div class="row">
      <div><label>Название</label><input id="name" /></div>
      <div><label>Район</label><input id="neighborhood" placeholder="Palermo, Belgrano, Recoleta..." /></div>
    </div>
    <div class="row">
      <div><label>Адрес</label><input id="address" /></div>
      <div><label>Пик посещений</label><input id="peak" placeholder="Пт–Сб 21–01, Сб 12–16..." /></div>
    </div>
    <div class="row">
      <div><label>Instagram</label><input id="insta" placeholder="https://instagram.com/..." /></div>
      <div><label>Сайт</label><input id="site" placeholder="https://..." /></div>
    </div>
    <div class="row">
      <div><label>Телефон</label><input id="phone" placeholder="+54..." /></div>
      <div><label>Фото (обложка, опц.)</label><input id="photo" placeholder="https://..." /></div>
    </div>
    <div class="row">
      <div><label>lat</label><input id="lat" /></div>
      <div><label>lng</label><input id="lng" /></div>
    </div>
    <div class="row">
      <div><label>place_id (если знаешь)</label><input id="placeid" /></div>
      <div><label>Плотность русских (0–5)</label><input id="rus" type="number" min="0" max="5" step="1" value="3"/></div>
    </div>
    <div class="row">
      <div><label>Заметка (опционально)</label><input id="notes" /></div>
      <div></div>
    </div>
  </div>

  <div class="card">
    <label>JSON</label>
    <textarea id="json" rows="10" readonly></textarea>
    <div class="hint">Кнопка «Отправить в GitHub» создаст Issue с этим JSON — просто нажми Submit.</div>
  </div>
</main>

<script>
const $ = id => document.getElementById(id);
const setStatus = (t, ok=false)=> { $('status').innerHTML = ok? `<span class="ok">${t}</span>` : t; };

$('btnParse').onclick = ()=>{
  const raw = $('query').value.trim();
  if(!raw){ setStatus('Вставь длинную ссылку или заполни поля ниже.'); return; }

  // Вытаскиваем из длинного URL: name (из /place/...), lat/lng из @lat,lng, address из query/formatted
  try{
    const url = new URL(raw);
    const path = decodeURIComponent(url.pathname);
    const name = path.split('/place/')[1]?.split('/')[0]?.replace(/\+/g,' ').replace(/_/g,' ') || '';
    if (name && !$('name').value) $('name').value = name;

    const at = raw.match(/@(-?\d+\.\d+),(-?\d+\.\d+)/);
    if (at){ $('lat').value = at[1]; $('lng').value = at[2]; }

    const q = url.searchParams.get('query');
    if (q && q.includes(',')) $('address').value = q;

    const pidMatch = raw.match(/place_id:([A-Za-z0-9_-]+)/i);
    if (pidMatch) $('placeid').value = pidMatch[1];

    setStatus('Готово: вытащил данные из ссылки. Проверь и дополни.', true);
  }catch(e){
    setStatus('Не похоже на длинный URL Google Maps. Открой короткую ссылку, скопируй длинную из адресной строки и вставь сюда.');
  }
};

function buildJson(){
  const obj = {
    id: Date.now(),
    name: $('name').value.trim(),
    category: $('category').value,
    subtype: '',
    lat: Number($('lat').value),
    lng: Number($('lng').value),
    neighborhood: $('neighborhood').value.trim(),
    russian_score: Number($('rus').value||0),
    peak_hours: $('peak').value.trim(),
    instagram: $('insta').value.trim(),
    website: $('site').value.trim(),
    phone: $('phone').value.trim(),
    photo_url: $('photo').value.trim(),
    address: $('address').value.trim(),
    place_id: $('placeid').value.trim(),
    notes: $('notes').value.trim()
  };
  $('json').value = JSON.stringify(obj, null, 2);
  return obj;
}
$('btnPreview').onclick = ()=>{ buildJson(); setStatus('Предпросмотр готов.', true); };
$('btnSubmit').onclick = ()=>{
  const obj = buildJson();
  if (!obj.name || !obj.category || !obj.lat || !obj.lng){
    setStatus('Нужно минимум: Название, Категория, lat и lng.', false); return;
  }
  const repo = "lommaks777/-russian-community";
  const title = encodeURIComponent("Новая точка: " + (obj.name||"без названия"));
  const body = encodeURIComponent(["Проверь и добавь в data/places.js","","```json",JSON.stringify(obj,null,2),"```"].join("\n"));
  window.open(`https://github.com/${repo}/issues/new?title=${title}&body=${body}`, "_blank");
};
</script>
</body>
</html>
