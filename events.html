<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>–°–æ–±—ã—Ç–∏—è ‚Äî –†—É—Å—Å–∫–∞—è –∫–∞—Ä—Ç–∞ –ë–ê</title>
  <style>
    :root{color-scheme:dark}
    html,body{margin:0;height:100%;background:#0f0f0f;color:#eee;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    header{position:fixed;top:0;left:0;right:0;z-index:10;background:#111;border-bottom:1px solid #222;display:flex;gap:12px;align-items:center;padding:10px 16px}
    header a{color:#9ecbff;text-decoration:none}
    header a:hover{text-decoration:underline}
    .content{position:absolute;top:48px;left:0;right:0;bottom:0;display:grid;grid-template-columns:380px 1fr}
    .list{overflow:auto;border-right:1px solid #222}
    .controls{padding:8px;border-bottom:1px solid #222;display:flex;gap:8px;flex-wrap:wrap}
    select,input{background:#181818;border:1px solid #2a2a2a;color:#eee;border-radius:8px;padding:6px 8px}
    .card{padding:12px 14px;border-bottom:1px solid #222}
    .title{font-weight:700}
    .muted{color:#9aa}
    .desc{margin-top:6px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:6px}
    .pill{background:#1a1a1a;border:1px solid #2a2a2a;border-radius:999px;padding:4px 8px;font-size:12px}
    .links a{color:#c9e1ff;text-decoration:none}
    .links a:hover{text-decoration:underline}
    #map{width:100%;height:100%}
    .empty{padding:16px;color:#aaa}
  </style>
</head>
<body>
<header>
  <a href="./">‚Üê –ù–∞ –∫–∞—Ä—Ç—É</a>
  <div style="flex:1"></div>
  <div>–°–æ–±—ã—Ç–∏—è –ë—É—ç–Ω–æ—Å-–ê–π—Ä–µ—Å–∞</div>
</header>

<div class="content">
  <div class="list">
    <div class="controls">
      <select id="tag">
        <option value="">–í—Å–µ —Ç–µ–≥–∏</option>
        <option>–º—É–∑—ã–∫–∞</option><option>–∫–æ–Ω—Ü–µ—Ä—Ç</option><option>—è—Ä–º–∞—Ä–∫–∞</option>
        <option>–≤–µ—á–µ—Ä–∏–Ω–∫–∞</option><option>–∫–∏–Ω–æ</option><option>—Ç–µ–∞—Ç—Ä</option>
        <option>–±–µ—Å–ø–ª–∞—Ç–Ω–æ</option><option>–¥–µ—Ç—è–º</option><option>—Ä—É—Å—Å–∫–æ—è–∑—ã—á–Ω–æ–µ</option>
      </select>
      <select id="price">
        <option value="">–õ—é–±–∞—è —Ü–µ–Ω–∞</option>
        <option value="free">–¢–æ–ª—å–∫–æ –±–µ—Å–ø–ª–∞—Ç–Ω–æ</option>
        <option value="paid">–¢–æ–ª—å–∫–æ –ø–ª–∞—Ç–Ω–æ</option>
      </select>
      <input id="q" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é‚Ä¶" />
    </div>
    <div id="items"></div>
  </div>
  <div id="map"></div>
</div>

<script src="data/events.js"></script>
<script>
const GOOGLE_KEY = "AIzaSyB7-RgotVuWFR6qMvr_Alf8nQvkYd7I3WI";
const MAP_ID = "573d7da16cb24e9ec7c4e07e";
const BA = {lat:-34.6037,lng:-58.3816};

const TAG_EMOJI = { –º—É–∑—ã–∫–∞:"üéµ", –∫–æ–Ω—Ü–µ—Ä—Ç:"üé§", —è—Ä–º–∞—Ä–∫–∞:"üõçÔ∏è", –≤–µ—á–µ—Ä–∏–Ω–∫–∞:"üéâ", –∫–∏–Ω–æ:"üé¨", —Ç–µ–∞—Ç—Ä:"üé≠", –±–µ—Å–ø–ª–∞—Ç–Ω–æ:"üÜì", –¥–µ—Ç—è–º:"üë∂", —Ä—É—Å—Å–∫–æ—è–∑—ã—á–Ω–æ–µ:"üá∑üá∫" };
const $ = id=>document.getElementById(id);

let map, info, markers=[];

(function loadMaps(){
  const s=document.createElement('script');
  s.src=`https://maps.googleapis.com/maps/api/js?key=${encodeURIComponent(GOOGLE_KEY)}&v=weekly&libraries=marker&language=ru&region=AR&callback=initMap`;
  s.defer=true; s.async=true; document.head.appendChild(s);
})();

function emojiFor(e){ if(e.tags?.length) for(const t of e.tags){ if(TAG_EMOJI[t]) return TAG_EMOJI[t]; } return "üéüÔ∏è"; }
function whenText(e){
  const start = new Date(e.start);
  const end = new Date(e.end||e.start);
  const sameDay = start.toDateString()===end.toDateString();
  const d = start.toLocaleDateString('ru-RU',{day:'2-digit',month:'short',year:'numeric'});
  const t1 = start.toLocaleTimeString('ru-RU',{hour:'2-digit',minute:'2-digit'});
  const t2 = end.toLocaleTimeString('ru-RU',{hour:'2-digit',minute:'2-digit'});
  return sameDay ? `${d}, ${t1}${e.end? '‚Äì'+t2:''}` : `${d}, ${t1} ‚Üí ${end.toLocaleString('ru-RU',{day:'2-digit',month:'short'})} ${t2}`;
}
function filtered(){
  const t=$('tag').value, p=$('price').value, q=($('q').value||'').trim().toLowerCase();
  return (window.EVENTS||[]).filter(e=>{
    const byTag = !t || (e.tags||[]).includes(t);
    const byPrice = !p || (p==='free' ? e.price?.is_free : !e.price?.is_free);
    const byQuery = !q || (e.title||'').toLowerCase().includes(q);
    return byTag && byPrice && byQuery;
  }).sort((a,b)=> new Date(a.start)-new Date(b.start));
}
function renderList(){
  const el=$('items'); el.innerHTML='';
  const arr=filtered();
  if(!arr.length){ el.innerHTML='<div class="empty">–°–æ–±—ã—Ç–∏–π –ø–æ–∫–∞ –Ω–µ—Ç.</div>'; return; }
  for(const e of arr){
    const tags=(e.tags||[]).map(t=>`<span class="pill">${TAG_EMOJI[t]||"üè∑Ô∏è"} ${t}</span>`).join(' ');
    const price = e.price?.is_free ? '–ë–µ—Å–ø–ª–∞—Ç–Ω–æ' : (e.price?.text || '');
    el.insertAdjacentHTML('beforeend', `
      <div class="card" data-id="${e.id}">
        <div class="title">${emojiFor(e)} ${e.title||''}</div>
        <div class="muted">${whenText(e)} ‚Ä¢ ${e.venue?.name||e.venue?.address||''}</div>
        ${e.description? `<div class="desc">${e.description}</div>`:''}
        <div class="row"><span class="pill">${price || '‚Äî'}</span>${tags? `<span>${tags}</span>`:''}</div>
        <div class="row links"><a href="${e.url}" target="_blank" rel="noopener">–ü–æ–¥—Ä–æ–±–Ω–µ–µ</a></div>
      </div>
    `);
  }
  el.querySelectorAll('.card').forEach(c=>{
    c.onclick=()=>{
      const ev=(window.EVENTS||[]).find(x=>x.id===c.dataset.id);
      if(!ev || !ev.location) return;
      map.panTo(ev.location);
      const m=markers.find(m=>m.__id===ev.id);
      if (m) google.maps.event.trigger(m,'click');
    };
  });
}
async function initMap(){
  const {Map}=await google.maps.importLibrary('maps');
  const {AdvancedMarkerElement, PinElement}=await google.maps.importLibrary('marker');
  map=new Map($('map'),{center:BA,zoom:12,mapId:MAP_ID,clickableIcons:false});
  info=new google.maps.InfoWindow();
  markers=[];
  (window.EVENTS||[]).forEach(e=>{
    if(!e.location) return; // –ø–∏–Ω —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞—Ö
    const glyph=document.createElement('div'); glyph.textContent=emojiFor(e); glyph.style.fontSize='22px'; glyph.style.lineHeight='22px';
    const pin=new PinElement({glyph,background:'#111',borderColor:'#444',glyphColor:'#fff',scale:1.1});
    const m=new AdvancedMarkerElement({map,position:e.location,content:pin.element,title:e.title}); m.__id=e.id;
    const html=`
      <div style="width:300px">
        <div style="font-weight:700">${emojiFor(e)} ${e.title||''}</div>
        <div class="muted">${whenText(e)}${e.venue?.name? ' ‚Ä¢ '+e.venue.name : ''}</div>
        ${e.price?.is_free? `<div>–ë–µ—Å–ø–ª–∞—Ç–Ω–æ</div>` : (e.price?.text? `<div>${e.price.text}</div>`:'')}
        ${e.description? `<div style="margin-top:6px">${e.description}</div>`:''}
        <div style="margin-top:6px"><a href="${e.url}" target="_blank" rel="noopener">–ü–æ–¥—Ä–æ–±–Ω–µ–µ</a></div>
      </div>`;
    m.addListener('click',()=>{ info.setContent(html); info.open({anchor:m,map}); });
    markers.push(m);
  });
  $('tag').onchange=renderList; $('price').onchange=renderList; $('q').oninput=renderList;
  renderList();
}
</script>
</body>
</html>
