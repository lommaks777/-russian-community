<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Русская карта Буэнос-Айреса</title>
  <style>
    html,body {height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .app{display:grid;grid-template-rows:auto 1fr;height:100%}
    header{padding:10px 12px;border-bottom:1px solid #222;background:#111;color:#eee;display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    header .title{font-weight:700}
    header .btn{padding:6px 10px;background:#222;border:1px solid #333;border-radius:14px;color:#ddd;cursor:pointer}
    header .btn.active{background:#0b57d0;border-color:#0b57d0;color:#fff}
    header .spacer{flex:1}
    #map{width:100%;height:100%}
    /* инфоокно */
    .infowrap{width:260px}
    .infoimg{width:100%;height:140px;object-fit:cover;display:block}
    .infosec{padding:10px}
    .infotitle{font-weight:700;margin-bottom:4px}
    .infometa{font-size:12px;color:#888}
    .photos{display:flex;gap:6px;margin-top:8px}
    .photos img{width:78px;height:58px;object-fit:cover;border-radius:6px}
    .links{margin-top:8px;font-size:13px;display:flex;gap:10px;flex-wrap:wrap}
    .links a{color:#0b57d0;text-decoration:none}
    .badge{display:inline-block;background:#222;color:#eee;border:1px solid #333;font-size:12px;border-radius:10px;padding:2px 6px;margin-top:6px}

    /* кастомные пины (Advanced Marker) */
    .pin{
      display:flex;align-items:center;gap:6px;
      background:rgba(24,24,24,.9);border:1px solid #333;border-radius:14px;padding:4px 8px;
      color:#eaeaea;font-size:12px;backdrop-filter:blur(3px);white-space:nowrap;
      box-shadow:0 2px 6px rgba(0,0,0,.35);
    }
    .pin .dot{
      width:18px;height:18px;border-radius:50%;
      border:2px solid rgba(0,0,0,.35); box-shadow: inset 0 0 0 1px rgba(255,255,255,.15);
    }
    .pin .name{max-width:180px;overflow:hidden;text-overflow:ellipsis}
    @media (max-width: 600px){ .pin .name{max-width:120px} }
  </style>
</head>
<body>
<div class="app">
  <header>
    <div class="title">Русская карта БА</div>
    <button id="toggleHeat" class="btn">Плотность русских</button>
    <button id="toggleRoute" class="btn">Маршрут пятницы</button>
    <div class="spacer"></div>
    <a class="btn" href="./add.html">Добавить своё место</a>
  </header>
  <div id="map"></div>
</div>

<!-- ДАННЫЕ -->
<script src="./data/places.js"></script>
<script src="./data/routes.js"></script>

<script>
/** 1) ВСТАВЬ СВОЙ GOOGLE MAPS API KEY В КАВЫЧКИ НИЖЕ **/
const GOOGLE_KEY = "YOUR_GOOGLE_MAPS_API_KEY_HERE";

/** 2) ЗАГРУЗКА КАРТЫ С БИБЛИОТЕКАМИ: places, visualization, marker (для AdvancedMarkerElement) **/
(function loadGoogle(){
  const s = document.createElement('script');
  s.src = `https://maps.googleapis.com/maps/api/js?key=${encodeURIComponent(GOOGLE_KEY)}&libraries=places,visualization,marker&v=weekly&callback=initMap`;
  s.async = true;
  document.head.appendChild(s);
})();

/** Тёмный стиль **/
const DARK_STYLE = [
  {"elementType":"geometry","stylers":[{"color":"#1f1f1f"}]},
  {"elementType":"labels.icon","stylers":[{"visibility":"off"}]},
  {"elementType":"labels.text.fill","stylers":[{"color":"#8b949e"}]},
  {"elementType":"labels.text.stroke","stylers":[{"color":"#1a1a1a"}]},
  {"featureType":"poi","elementType":"geometry","stylers":[{"color":"#2a2a2a"}]},
  {"featureType":"road","elementType":"geometry","stylers":[{"color":"#2b2b2b"}]},
  {"featureType":"water","elementType":"geometry","stylers":[{"color":"#0f1419"}]}
];

let map, info, heatmap, routeLine;

/** цвета для категорий (точка в пине) */
const CAT_COLORS = {
  "Кофе":"#ffb703",
  "Кальян":"#7b2cbf",
  "Спорт":"#00d4ff",
  "Работа":"#00d084",
  "Магазин":"#ff6b6b",
  "Рестораны":"#f77f00",
  "Бары":"#e63946",
  "Ивенты":"#3a86ff",
  "Услуги":"#4cc9f0",
  "Дети":"#ffd166"
};

function pinContent(place){
  const wrap = document.createElement('div');
  wrap.className = 'pin';
  const dot = document.createElement('div');
  dot.className = 'dot';
  dot.style.background = CAT_COLORS[place.category] || '#9e9e9e';
  const name = document.createElement('div');
  name.className = 'name';
  name.textContent = place.name || 'Место';
  wrap.appendChild(dot);
  wrap.appendChild(name);
  return wrap;
}

function initMap(){
  map = new google.maps.Map(document.getElementById('map'), {
    center: {lat: -34.6037, lng: -58.3816},
    zoom: 12,
    styles: DARK_STYLE,
    disableDefaultUI: false,
    mapTypeControl: false,
    streetViewControl: false
  });
  info = new google.maps.InfoWindow();

  renderMarkers();
  setupHeatmapButton();
  setupRouteButton();
}

function renderMarkers(){
  const svc = new google.maps.places.PlacesService(map);

  (window.PLACES || []).forEach(p => {
    // AdvancedMarker с кастомным DOM-контентом (иконка + название на пине)
    const marker = new google.maps.marker.AdvancedMarkerElement({
      map,
      position: {lat: Number(p.lat), lng: Number(p.lng)},
      content: pinContent(p),
      title: p.name || ''
    });

    let detailsCached = null;

    const openInfo = async () => {
      const html = await buildInfo(p, svc, detailsCached);
      if (html.details) detailsCached = html.details;
      info.setContent(html.content);
      info.open({anchor: marker, map});
      map.panTo({lat:Number(p.lat), lng:Number(p.lng)});
    };

    marker.addListener('click', openInfo);
  });
}

function buildInfo(p, svc, cached){
  return new Promise(resolve=>{
    const output = { content: "", details: null };

    const basic = (extrasHtml="") => `
      <div class="infowrap">
        <img class="infoimg" src="${(p.photo_url||"https://picsum.photos/seed/spot/600/400")}" alt="">
        <div class="infosec">
          <div class="infotitle">${p.name||"Без названия"}</div>
          <div class="infometa">${(p.subtype||p.category||"Место")} • ${p.neighborhood||""}</div>
          <div class="badge">Русских: ${(p.russian_score||0)}/5</div>
          ${p.peak_hours?`<div class="infometa" style="margin-top:4px">Пик: ${p.peak_hours}</div>`:""}
          ${extrasHtml}
        </div>
      </div>
    `;

    if (p.place_id){
      const useDetails = (details) => {
        output.details = details;
        const rating = details.rating ? `⭐ ${details.rating.toFixed(1)} (${details.user_ratings_total||0})` : "";
        const photos = (details.photos||[]).slice(0,3).map(ph => {
          const url = ph.getUrl({maxWidth: 300, maxHeight: 200});
          return `<img src="${url}" alt="">`;
        }).join("");
        const site = details.website ? `<a href="${details.website}" target="_blank" rel="noopener">Сайт</a>` : "";
        const phone = details.international_phone_number ? `<a href="tel:${details.international_phone_number}">Телефон</a>` : "";
        const gpage = details.url ? `<a href="${details.url}" target="_blank" rel="noopener">Google</a>` : "";
        const insta = p.instagram ? `<a href="${p.instagram}" target="_blank" rel="noopener">Instagram</a>` : "";
        const extras = `
          ${rating?`<div class="infometa" style="margin-top:6px">${rating}</div>`:""}
          ${photos?`<div class="photos">${photos}</div>`:""}
          <div class="links">${[site, phone, gpage, insta].filter(Boolean).join("")}</div>
        `;
        output.content = basic(extras);
        resolve(output);
      };

      if (cached){ useDetails(cached); return; }

      svc.getDetails({
        placeId: p.place_id,
        fields: ["name","rating","user_ratings_total","photos","website","international_phone_number","url"]
      }, (details,status)=>{
        if (status === google.maps.places.PlacesServiceStatus.OK && details){
          useDetails(details);
        } else {
          const links = [
            p.website ? `<a href="${p.website}" target="_blank" rel="noopener">Сайт</a>` : "",
            p.phone ? `<a href="tel:${p.phone}">Телефон</a>` : "",
            p.instagram ? `<a href="${p.instagram}" target="_blank" rel="noopener">Instagram</a>` : "",
          ].filter(Boolean).join("");
          const extras = `<div class="links">${links}</div>`;
          output.content = basic(extras);
          resolve(output);
        }
      });
    } else {
      const links = [
        p.website ? `<a href="${p.website}" target="_blank" rel="noopener">Сайт</a>` : "",
        p.phone ? `<a href="tel:${p.phone}">Телефон</a>` : "",
        p.instagram ? `<a href="${p.instagram}" target="_blank" rel="noopener">Instagram</a>` : "",
      ].filter(Boolean).join("");
      const extras = `<div class="links">${links}</div>`;
      output.content = basic(extras);
      resolve(output);
    }
  });
}

function setupHeatmapButton(){
  const btn = document.getElementById('toggleHeat');
  btn.addEventListener('click', ()=>{
    if (!heatmap) {
      const points = (window.PLACES||[]).map(p => ({
        location: new google.maps.LatLng(Number(p.lat), Number(p.lng)),
        weight: Math.max(0, Math.min(5, Number(p.russian_score||0))) // 0..5
      }));
      heatmap = new google.maps.visualization.HeatmapLayer({ data: points, map: map, radius: 32, opacity: 0.6 });
      btn.classList.add('active');
    } else {
      if (heatmap.getMap()) { heatmap.setMap(null); btn.classList.remove('active'); }
      else { heatmap.setMap(map); btn.classList.add('active'); }
    }
  });
}

function setupRouteButton(){
  const btn = document.getElementById('toggleRoute');
  btn.addEventListener('click', ()=>{
    if (routeLine) {
      const isOn = !!routeLine.getMap();
      routeLine.setMap(isOn?null:map);
      btn.classList.toggle('active', !isOn);
      return;
    }
    const routeIds = (window.ROUTES && window.ROUTES.friday) ? window.ROUTES.friday : [];
    const points = routeIds
      .map(id => (window.PLACES||[]).find(p=>p.id===id))
      .filter(Boolean)
      .map(p => ({ lat: Number(p.lat), lng: Number(p.lng) }));

    if (!points.length){ alert('Маршрут пятницы пока пустой.'); return; }

    routeLine = new google.maps.Polyline({
      path: points, geodesic: true, strokeColor: '#0b57d0', strokeOpacity: 0.9, strokeWeight: 4
    });
    routeLine.setMap(map);
    btn.classList.add('active');

    const bounds = new google.maps.LatLngBounds();
    points.forEach(pt=>bounds.extend(pt));
    map.fitBounds(bounds, { top:80, bottom:40, left:40, right:40 });
  });
}
</script>
</body>
</html>
