<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Русская карта Буэнос-Айреса</title>
  <style>
    html,body {height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .app{display:grid;grid-template-rows:auto 1fr;height:100%}
    header{padding:10px 12px;border-bottom:1px solid #222;background:#111;color:#eee;display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    header .title{font-weight:700}
    header .btn{padding:6px 10px;background:#222;border:1px solid #333;border-radius:14px;color:#ddd;cursor:pointer}
    header .btn.active{background:#0b57d0;border-color:#0b57d0;color:#fff}
    #map{width:100%;height:100%}
    .gm-style .gm-style-iw-c{padding:0!important;border-radius:10px;overflow:hidden}
    .infowrap{width:260px}
    .infoimg{width:100%;height:140px;object-fit:cover;display:block}
    .infosec{padding:10px}
    .infotitle{font-weight:700;margin-bottom:4px}
    .infometa{font-size:12px;color:#666}
    .photos{display:flex;gap:6px;margin-top:8px}
    .photos img{width:78px;height:58px;object-fit:cover;border-radius:6px}
    .links{margin-top:8px;font-size:13px;display:flex;gap:10px;flex-wrap:wrap}
    .links a{color:#0b57d0;text-decoration:none}
    .badge{display:inline-block;background:#222;color:#eee;border:1px solid #333;font-size:12px;border-radius:10px;padding:2px 6px;margin-top:6px}
  </style>
</head>
<body>
<div class="app">
  <header>
    <div class="title">Русская карта БА</div>
    <button id="toggleHeat" class="btn">Плотность русских</button>
  </header>
  <div id="map"></div>
</div>

<!-- ДАННЫЕ -->
<script src="./data/places.js"></script>

<script>
/** 1) ВСТАВЬ СВОЙ GOOGLE MAPS API KEY В СТРОКУ НИЖЕ (между кавычек) **/
const GOOGLE_KEY = "YOUR_GOOGLE_MAPS_API_KEY_HERE";

/** 2) СКРИПТ ЗАГРУЗКИ КАРТЫ С БИБЛИОТЕКАМИ places + visualization **/
(function loadGoogle(){
  const s = document.createElement('script');
  s.src = `https://maps.googleapis.com/maps/api/js?key=${encodeURIComponent(GOOGLE_KEY)}&libraries=places,visualization&v=weekly&callback=initMap`;
  s.async = true;
  document.head.appendChild(s);
})();

/** Темная тема (через styles) **/
const DARK_STYLE = [
  {"elementType":"geometry","stylers":[{"color":"#1f1f1f"}]},
  {"elementType":"labels.icon","stylers":[{"visibility":"off"}]},
  {"elementType":"labels.text.fill","stylers":[{"color":"#8b949e"}]},
  {"elementType":"labels.text.stroke","stylers":[{"color":"#1a1a1a"}]},
  {"featureType":"administrative","elementType":"geometry","stylers":[{"color":"#3a3a3a"}]},
  {"featureType":"poi","elementType":"geometry","stylers":[{"color":"#2a2a2a"}]},
  {"featureType":"poi","elementType":"labels.text.fill","stylers":[{"color":"#8b949e"}]},
  {"featureType":"poi.park","elementType":"geometry","stylers":[{"color":"#243024"}]},
  {"featureType":"road","elementType":"geometry","stylers":[{"color":"#2b2b2b"}]},
  {"featureType":"road","elementType":"labels.text.fill","stylers":[{"color":"#9aa0a6"}]},
  {"featureType":"road.highway","elementType":"geometry","stylers":[{"color":"#3a3a3a"}]},
  {"featureType":"transit","elementType":"geometry","stylers":[{"color":"#2a2a2a"}]},
  {"featureType":"water","elementType":"geometry","stylers":[{"color":"#0f1419"}]},
  {"featureType":"water","elementType":"labels.text.fill","stylers":[{"color":"#8b949e"}]}
];

let map, info, heatmap;

function initMap(){
  map = new google.maps.Map(document.getElementById('map'), {
    center: {lat: -34.6037, lng: -58.3816},
    zoom: 12,
    styles: DARK_STYLE,
    disableDefaultUI: false,
    mapTypeControl: false,
    streetViewControl: false
  });
  info = new google.maps.InfoWindow();

  renderMarkers();
  setupHeatmapButton();
}

function renderMarkers(){
  const svc = new google.maps.places.PlacesService(map);

  (window.PLACES || []).forEach(place => {
    const marker = new google.maps.Marker({
      position: {lat: Number(place.lat), lng: Number(place.lng)},
      map,
      title: place.name
    });

    let detailsCached = null;

    const openInfo = async () => {
      const html = await buildInfo(place, svc, detailsCached);
      if (html.details) detailsCached = html.details;
      info.setContent(html.content);
      info.open({anchor: marker, map});
    };

    marker.addListener('click', openInfo);
  });
}

function buildInfo(p, svc, cached){
  return new Promise(resolve=>{
    const output = { content: "", details: null };

    const basic = (extrasHtml="") => `
      <div class="infowrap">
        <img class="infoimg" src="${(p.photo_url||"https://picsum.photos/seed/spot/600/400")}" alt="">
        <div class="infosec">
          <div class="infotitle">${p.name||"Без названия"}</div>
          <div class="infometa">${(p.subtype||p.category||"Место")} • ${p.neighborhood||""}</div>
          <div class="badge">Русских: ${(p.russian_score||0)}/5</div>
          ${p.peak_hours?`<div class="infometa" style="margin-top:4px">Пик: ${p.peak_hours}</div>`:""}
          ${extrasHtml}
        </div>
      </div>
    `;

    // Если есть place_id — пытаемся подтянуть детали (рейтинг, фото, сайт, телефон)
    if (p.place_id){
      const useDetails = (details) => {
        output.details = details;
        const rating = details.rating ? `⭐ ${details.rating.toFixed(1)} (${details.user_ratings_total||0})` : "";
        const photos = (details.photos||[]).slice(0,3).map(ph => {
          const url = ph.getUrl({maxWidth: 300, maxHeight: 200});
          return `<img src="${url}" alt="">`;
        }).join("");
        const site = details.website ? `<a href="${details.website}" target="_blank" rel="noopener">Сайт</a>` : "";
        const phone = details.international_phone_number ? `<a href="tel:${details.international_phone_number}">Телефон</a>` : "";
        const gpage = details.url ? `<a href="${details.url}" target="_blank" rel="noopener">Google</a>` : "";
        const insta = p.instagram ? `<a href="${p.instagram}" target="_blank" rel="noopener">Instagram</a>` : "";

        const extras = `
          ${rating?`<div class="infometa" style="margin-top:6px">${rating}</div>`:""}
          ${photos?`<div class="photos">${photos}</div>`:""}
          <div class="links">${[site, phone, gpage, insta].filter(Boolean).join("")}</div>
        `;
        output.content = basic(extras);
        resolve(output);
      };

      if (cached){ useDetails(cached); return; }

      svc.getDetails({
        placeId: p.place_id,
        fields: ["name","rating","user_ratings_total","photos","website","international_phone_number","url"]
      }, (details,status)=>{
        if (status === google.maps.places.PlacesServiceStatus.OK && details){
          useDetails(details);
        } else {
          // Фолбэк: только наши данные
          const links = [
            p.website ? `<a href="${p.website}" target="_blank" rel="noopener">Сайт</a>` : "",
            p.phone ? `<a href="tel:${p.phone}">Телефон</a>` : "",
            p.instagram ? `<a href="${p.instagram}" target="_blank" rel="noopener">Instagram</a>` : "",
          ].filter(Boolean).join("");
          const extras = `<div class="links">${links}</div>`;
          output.content = basic(extras);
          resolve(output);
        }
      });
    } else {
      // Нет place_id — показываем только ручные поля
      const links = [
        p.website ? `<a href="${p.website}" target="_blank" rel="noopener">Сайт</a>` : "",
        p.phone ? `<a href="tel:${p.phone}">Телефон</a>` : "",
        p.instagram ? `<a href="${p.instagram}" target="_blank" rel="noopener">Instagram</a>` : "",
      ].filter(Boolean).join("");
      const extras = `<div class="links">${links}</div>`;
      output.content = basic(extras);
      resolve(output);
    }
  });
}

function setupHeatmapButton(){
  const btn = document.getElementById('toggleHeat');
  btn.addEventListener('click', ()=>{
    if (!heatmap) {
      const points = (window.PLACES||[]).map(p => ({
        location: new google.maps.LatLng(Number(p.lat), Number(p.lng)),
        weight: Math.max(0, Math.min(5, Number(p.russian_score||0))) // 0..5
      }));
      heatmap = new google.maps.visualization.HeatmapLayer({
        data: points,
        map: map,
        radius: 30,
        opacity: 0.6
      });
      btn.classList.add('active');
    } else {
      if (heatmap.getMap()) { heatmap.setMap(null); btn.classList.remove('active'); }
      else { heatmap.setMap(map); btn.classList.add('active'); }
    }
  });
}
</script>
</body>
</html>
