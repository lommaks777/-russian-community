<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>–†—É—Å—Å–∫–∞—è –∫–∞—Ä—Ç–∞ –ë–ê</title>
  <link rel="icon" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64"><circle cx="32" cy="32" r="28" fill="%230b57d0"/><text x="32" y="40" font-size="28" text-anchor="middle" fill="white" font-family="Arial, Helvetica, sans-serif">R</text></svg>' />
  <style>
    :root { color-scheme: dark; }
    html, body { height:100%; margin:0; background:#0f0f0f; color:#eee; font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; }
    header {
      position: fixed; top:0; left:0; right:0; z-index:1000;
      background:#111; border-bottom:1px solid #222;
      display:flex; gap:12px; align-items:center; padding:10px 16px; font-size:15px;
    }
    header a { color:#9ecbff; text-decoration:none; font-weight:500; }
    header a:hover { text-decoration:underline; }
    .wrap { position:absolute; top:44px; left:0; right:0; bottom:0; }
    #map  { width:100%; height:100%; }
    .err { position:fixed; left:10px; bottom:10px; background:#1e1e1e; border:1px solid #333; color:#f66; padding:8px 10px; border-radius:8px; font-size:12px; max-width:90vw; display:none; }
  </style>
</head>
<body>
<header>
  <div style="flex:1;font-weight:600">–†—É—Å—Å–∫–∞—è –∫–∞—Ä—Ç–∞ –ë–ê</div>
  <a href="add.html">–î–æ–±–∞–≤–∏—Ç—å –º–µ—Å—Ç–æ</a>
</header>

<div class="wrap"><div id="map"></div></div>
<div id="err" class="err"></div>

<!-- –î–∞–Ω–Ω—ã–µ —Ç–æ—á–µ–∫ (–≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è Actions). –§–∞–π–ª –î–û–õ–ñ–ï–ù —Å—É—â–µ—Å—Ç–≤–æ–≤–∞—Ç—å -->
<script src="data/places.js"></script>

<script>
/* === –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π map.js === */
const GOOGLE_KEY = "AIzaSyB7-RgotVuWFR6qMvr_Alf8nQvkYd7I3WI";
const MAP_ID     = "573d7da16cb24e9ec7c4e07e";
const BA_CENTER  = { lat:-34.6037, lng:-58.3816 };

const CATEGORY_EMOJI = {
  "–ö–æ—Ñ–µ":"‚òï","–†–µ—Å—Ç–æ—Ä–∞–Ω—ã":"üçΩÔ∏è","–ë–∞—Ä—ã":"üç∏","–ö–∞–ª—å—è–Ω":"üí®","–°–ø–æ—Ä—Ç":"üèüÔ∏è","–†–∞–±–æ—Ç–∞":"üíº",
  "–ú–∞–≥–∞–∑–∏–Ω":"üõçÔ∏è","–ò–≤–µ–Ω—Ç—ã":"üéâ","–£—Å–ª—É–≥–∏":"üß∞","–î–µ—Ç–∏":"üë∂","–û–±—É—á–µ–Ω–∏–µ":"üéì"
};

const ERR = (t)=>{ const el=document.getElementById('err'); el.textContent=t; el.style.display='block'; };

(function loadMaps(){
  // –µ—Å–ª–∏ data/places.js –Ω–µ —É—Å–ø–µ–ª –∑–∞–≥—Ä—É–∑–∏—Ç—å—Å—è ‚Äî –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ
  if (!Array.isArray(window.PLACES)) window.PLACES = [];
  const url = `https://maps.googleapis.com/maps/api/js?key=${encodeURIComponent(GOOGLE_KEY)}&v=weekly&libraries=marker&language=ru&region=AR&loading=async&callback=initMap`;
  const s = document.createElement('script');
  s.src=url; s.defer=true; s.async=true;
  s.onerror = ()=>ERR('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å Google Maps JS (–ø—Ä–æ–≤–µ—Ä—å –∫–ª—é—á/–¥–æ–º–µ–Ω/–∏–Ω—Ç–µ—Ä–Ω–µ—Ç).');
  document.head.appendChild(s);
})();

function withKeyForPlacesMedia(url){
  if (!url) return "";
  try{
    const u = new URL(url);
    if (u.hostname === "places.googleapis.com" && u.pathname.includes("/v1/") && u.pathname.endsWith("/media")){
      if (!u.searchParams.has("key")) u.searchParams.set("key", GOOGLE_KEY);
      return u.toString();
    }
  }catch{}
  return url;
}

async function initMap(){
  try{
    const {Map} = await google.maps.importLibrary("maps");
    const {AdvancedMarkerElement, PinElement} = await google.maps.importLibrary("marker");

    const map = new Map(document.getElementById("map"), {
      center: BA_CENTER, zoom: 12, mapId: MAP_ID, clickableIcons: false
    });

    const infowin = new google.maps.InfoWindow();

    (window.PLACES || []).forEach(p => {
      const emoji = CATEGORY_EMOJI[p.category] || "üìç";

      const glyph = document.createElement("div");
      glyph.textContent = emoji;
      glyph.style.fontSize = "22px";
      glyph.style.lineHeight = "22px";

      const pin = new PinElement({
        glyph, background: "#111", borderColor:"#444", glyphColor:"#fff", scale: 1.1
      });

      const marker = new AdvancedMarkerElement({
        map, position:{lat:+p.lat,lng:+p.lng}, content: pin.element, title: p.name
      });

      const photo = withKeyForPlacesMedia(p.photo_url);
      const img = photo
        ? `<img src="${photo}" alt="" style="width:100%;max-height:180px;object-fit:cover;border-radius:10px"
                 onerror="this.remove()">`
        : "";

      const site  = p.website   ? `<div><a href="${p.website}" target="_blank" rel="noopener">–°–∞–π—Ç</a></div>` : "";
      const insta = p.instagram ? `<div><a href="${p.instagram}" target="_blank" rel="noopener">Instagram</a></div>` : "";
      const phone = p.phone     ? `<div>‚òé ${p.phone}</div>` : "";

      const html = `
        <div style="width:320px">
          ${img}
          <div style="margin-top:8px;font-weight:700;font-size:18px">${emoji} ${p.name || ""}</div>
          <div style="color:#999;margin:2px 0">${p.address || ""}</div>
          ${site}${insta}${phone}
        </div>`;

      marker.addListener("click", () => {
        infowin.setContent(html);
        infowin.open({anchor: marker, map});
      });
    });
  }catch(e){
    console.error(e);
    ERR('–ö–∞—Ä—Ç–∞ –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–ª–∞—Å—å. –û—Ç–∫—Ä–æ–π –∫–æ–Ω—Å–æ–ª—å (F12) ‚Üí Console: –ø—Ä–æ–≤–µ—Ä—å –æ—à–∏–±–∫–∏ –∫–ª—é—á–∞/–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π.');
  }
}
</script>
</body>
</html>
