<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Русская карта Буэнос-Айреса</title>
  <style>
    html,body {height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .app{display:grid;grid-template-rows:auto 1fr;height:100%}
    header{padding:10px 12px;border-bottom:1px solid #222;background:#111;color:#eee;display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    header .title{font-weight:700}
    header .btn{padding:6px 10px;background:#222;border:1px solid #333;border-radius:14px;color:#ddd;cursor:pointer}
    header .btn.active{background:#0b57d0;border-color:#0b57d0;color:#fff}
    header .spacer{flex:1}
    #map{width:100%;height:100%}
    .infowrap{width:260px}
    .infoimg{width:100%;height:140px;object-fit:cover;display:block}
    .infosec{padding:10px}
    .infotitle{font-weight:700;margin-bottom:4px}
    .infometa{font-size:12px;color:#888}
    .photos{display:flex;gap:6px;margin-top:8px}
    .photos img{width:78px;height:58px;object-fit:cover;border-radius:6px}
    .links{margin-top:8px;font-size:13px;display:flex;gap:10px;flex-wrap:wrap}
    .links a{color:#9ecbff;text-decoration:none}
    .badge{display:inline-block;background:#222;color:#eee;border:1px solid #333;font-size:12px;border-radius:10px;padding:2px 6px;margin-top:6px}

    .pin{display:flex;align-items:center;gap:6px;background:rgba(0,0,0,.85);border:1px solid rgba(255,255,255,.2);
         border-radius:14px;padding:4px 8px;color:#fff;font-size:13px;font-weight:600;white-space:nowrap;
         box-shadow:0 2px 6px rgba(0,0,0,.35);backdrop-filter:blur(3px)}
    .pin .dot{width:18px;height:18px;border-radius:50%;border:2px solid rgba(0,0,0,.35)}
    .pin .name{max-width:200px;overflow:hidden;text-overflow:ellipsis}
    @media (max-width:600px){ .pin .name{max-width:140px} }
  </style>
</head>
<body>
<div class="app">
  <header>
    <div class="title">Русская карта БА</div>
    <button id="toggleHeat" class="btn">Плотность русских</button>
    <button id="toggleRoute" class="btn">Маршрут пятницы</button>
    <div class="spacer"></div>
    <a class="btn" href="./add.html">Добавить своё место</a>
  </header>
  <div id="map"></div>
</div>

<!-- ДАННЫЕ -->
<script src="./data/places.js"></script>
<script src="./data/routes.js"></script>
<script src="map.js"></script>

<script>
const GOOGLE_KEY = "AIzaSyB7-RgotVuWFR6qMvr_Alf8nQvkYd7I3WI";
const MAP_ID     = "573d7da16cb24e9ec7c4e07e";                // ← вставь Map ID

// грузим по best-practice: loading=async (убирает ворнинг)
(function loadGoogle(){
  const url = `https://maps.googleapis.com/maps/api/js?key=${encodeURIComponent(GOOGLE_KEY)}&libraries=visualization,marker&language=ru&region=AR&v=weekly&loading=async&callback=initMap`;
  const s = document.createElement('script'); s.src = url; s.async = true; s.defer = true; document.head.appendChild(s);
})();

const DARK_STYLE = [
  {"elementType":"geometry","stylers":[{"color":"#1f1f1f"}]},
  {"elementType":"labels.icon","stylers":[{"visibility":"off"}]},
  {"elementType":"labels.text.fill","stylers":[{"color":"#8b949e"}]},
  {"elementType":"labels.text.stroke","stylers":[{"color":"#1a1a1a"}]},
  {"featureType":"poi","elementType":"geometry","stylers":[{"color":"#2a2a2a"}]},
  {"featureType":"road","elementType":"geometry","stylers":[{"color":"#2b2b2b"}]},
  {"featureType":"water","elementType":"geometry","stylers":[{"color":"#0f1419"}]}
];

let map, heatmap, info, routeLine;

const CAT_COLORS = {"Кофе":"#ffb703","Кальян":"#7b2cbf","Спорт":"#00d4ff","Работа":"#00d084","Магазин":"#ff6b6b","Рестораны":"#f77f00","Бары":"#e63946","Ивенты":"#3a86ff","Услуги":"#4cc9f0","Дети":"#ffd166"};

function pinContent(place){
  const wrap = document.createElement('div'); wrap.className='pin';
  const dot = document.createElement('div'); dot.className='dot'; dot.style.background = CAT_COLORS[place.category]||'#9e9e9e';
  const name = document.createElement('div'); name.className='name'; name.textContent = place.name||'Место';
  wrap.appendChild(dot); wrap.appendChild(name); return wrap;
}

function initMap(){
  map = new google.maps.Map(document.getElementById('map'), {
    center:{lat:-34.6037,lng:-58.3816}, zoom:12, styles:DARK_STYLE, mapId: MAP_ID,
    disableDefaultUI:false, mapTypeControl:false, streetViewControl:false
  });
  info = new google.maps.InfoWindow();

  renderMarkers();
  setupHeatmap();
  setupRoute();
}

function renderMarkers(){
  const AdvancedMarker = google.maps.marker?.AdvancedMarkerElement;
  (window.PLACES||[]).forEach(p=>{
    let marker;
    if (AdvancedMarker && MAP_ID) {
      marker = new AdvancedMarker({ map, position:{lat:+p.lat, lng:+p.lng}, content: pinContent(p), title:p.name||'' });
    } else {
      marker = new google.maps.Marker({ map, position:{lat:+p.lat, lng:+p.lng}, title:p.name||'' });
    }
    marker.addListener('click', ()=> openInfo(p));
  });
}

function openInfo(p){
  const content = `
    <div class="infowrap">
      <img class="infoimg" src="${p.photo_url||'https://picsum.photos/seed/spot/600/400'}" alt="">
      <div class="infosec">
        <div class="infotitle">${p.name||'Без названия'}</div>
        <div class="infometa">${(p.subtype||p.category||'Место')} • ${p.neighborhood||''}</div>
        <div class="badge">Русских: ${(p.russian_score||0)}/5</div>
        ${p.peak_hours?`<div class="infometa" style="margin-top:4px">Пик: ${p.peak_hours}</div>`:""}
        <div class="links">
          ${p.website?`<a href="${p.website}" target="_blank" rel="noopener">Сайт</a>`:''}
          ${p.phone?`<a href="tel:${p.phone}">Телефон</a>`:''}
          ${p.instagram?`<a href="${p.instagram}" target="_blank" rel="noopener">Instagram</a>`:''}
        </div>
      </div>
    </div>
  `;
  info.setContent(content);
  info.setPosition({lat:+p.lat, lng:+p.lng});
  info.open({map});
}

function setupHeatmap(){
  const btn = document.getElementById('toggleHeat');
  btn.onclick = ()=>{
    if (!heatmap){
      const pts = (window.PLACES||[]).map(p=>({location:new google.maps.LatLng(+p.lat,+p.lng),weight:Math.max(0,Math.min(5, +p.russian_score||0))}));
      heatmap = new google.maps.visualization.HeatmapLayer({ data: pts, map, radius:32, opacity:0.6 });
      btn.classList.add('active');
    } else {
      if (heatmap.getMap()) { heatmap.setMap(null); btn.classList.remove('active'); }
      else { heatmap.setMap(map); btn.classList.add('active'); }
    }
  };
}

function setupRoute(){
  const btn = document.getElementById('toggleRoute');
  btn.onclick = ()=>{
    if (routeLine){ const on = !!routeLine.getMap(); routeLine.setMap(on?null:map); btn.classList.toggle('active', !on); return; }
    const ids = (window.ROUTES && window.ROUTES.friday)||[];
    const pts = ids.map(id => (window.PLACES||[]).find(p=>p.id===id)).filter(Boolean).map(p=>({lat:+p.lat,lng:+p.lng}));
    if (!pts.length) { alert('Маршрут пятницы пуст.'); return; }
    routeLine = new google.maps.Polyline({ path: pts, geodesic:true, strokeColor:'#0b57d0', strokeOpacity:0.9, strokeWeight:4 });
    routeLine.setMap(map); btn.classList.add('active');
    const b = new google.maps.LatLngBounds(); pts.forEach(pt=>b.extend(pt)); map.fitBounds(b, { top:80, bottom:40, left:40, right:40 });
  };
}
</script>
</body>
</html>
